<div class="container mx-auto px-4 py-8">
  <%= form_for(@transaction, html: { data: { controller: "checkbox-new-form-transaction" }, class: "space-y-6" }) do |f| %>
    <% if @transaction.errors.any? %>
      <div id="error_explanation" class="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded relative" role="alert">
        <h2 class="font-bold"><%= pluralize(@transaction.errors.count, "error") %> <%= t('.prohibited') %>:</h2>
        <ul class="list-disc list-inside">
          <% @transaction.errors.full_messages.each do |message| %>
            <li><%= message %></li>
          <% end %>
        </ul>
      </div>
    <% end %>
    <% if @services.empty? %>
      <% if policy(Service).create? %>
        <%= link_to t("button.new", model: Service.model_name.human.downcase), new_service_path, class: "btn btn-primary" %>
      <% end %>
    <% else %>
      <div class="space-y-4">
        <div class="field">
          <%= f.label :date, class: "block text-lg font-medium text-gray-700" %>
          <%= f.input :date, as: :string, input_html: { data: { controller: "datepicker" }, class: "block w-full p-3 border border-gray-300 rounded-lg shadow-sm focus:ring-2 focus:ring-indigo-500" } %>
        </div>
        <div class="field">
          <%= f.label :client_id, class: "block text-lg font-medium text-gray-700" %>
          <%= f.input :client_id, collection: @clients, prompt: 'Select a client', required: true, label_method: :full_name, value_method: :id, input_html: { class: "block w-full p-3 border border-gray-300 rounded-lg shadow-sm focus:ring-2 focus:ring-indigo-500" } %>
          <% if @transaction.errors[:client_id].any? %>
            <div class="text-red-600">
              <%= @transaction.errors[:client_id].join(", ") %>
            </div>
          <% end %>
        </div>
        <div class="field">
          <%= f.label :services, class: "block text-lg font-medium text-gray-700" %>
          <div id="services" class="space-y-2">
            <% @services.each do |service| %>
              <div>
                <% checked = params[:transaction] && params[:transaction][:services]&.any? { |p| p[:name] == service.name } %>
                <%= check_box_tag 'transaction[services][][name]', service.name, checked, id: "transaction_services_name_#{service.id}", class: "mr-2 service-name-checkbox", data: { target: "transaction_services_price_#{service.id}" } %>
                <%= check_box_tag 'transaction[services][][price]', service.price, checked, id: "transaction_services_price_#{service.id}", style: "display: none" %>
                <%= service.name %> - <%= number_to_currency(service.price, unit: "$") %>
                <% if checked %>
                  <%= hidden_field_tag 'transaction[services][][name]', service.name %>
                  <%= hidden_field_tag 'transaction[services][][price]', service.price %>
                <% end %>
              </div>
            <% end %>
          </div>
        </div>
        <div class="actions mt-6">
          <%= f.submit class: "bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded" %>
        </div>
      </div>
    <% end %>
  <% end %>
</div>
